async function createRecipe(req, res) {
  try {
    console.log("createRecipe called once for recipe:", req.body.title);
    let { title, description, category, cooking_time, difficulty, ingredients, steps } = req.body;
    const submitted_by = req.user.id;

    if (!submitted_by) {
      return res.status(400).json({ message: "You must have an account to submit a recipe" });
    }

    if (typeof ingredients === "string") {
      ingredients = JSON.parse(ingredients);
    }
    if (typeof steps === "string") {
      steps = JSON.parse(steps);
    }

    const newRecipe = await recipeModel.createRecipe(
      title,
      description,
      submitted_by,
      category,
      cooking_time,
      difficulty
    );

    const recipe_id = newRecipe.recipe_id;
    let recipe_image;

    if (req.file) {
      const image_name = req.file.filename;
      const image_url = `/images/recipes/${image_name}`;
      recipe_image = await recipeModel.addRecipeImage(recipe_id, image_url, image_name);
    }

    if (ingredients && ingredients.length > 0) {
      for (const ing of ingredients) {
        let ingredient = await recipeModel.getIngredientByName(ing.name);
        if (!ingredient) {
          ingredient = await recipeModel.addIngredient(ing.name);
        }
        await recipeModel.addRecipeIngredient(recipe_id, ingredient.ingredient_id, ing.quantity || null);
      }
    }

    if (Array.isArray(steps) && steps.length > 0) {
      steps = steps.flat();
      console.log("Steps received:", steps);
      for (let i = 0; i < steps.length; i++) {
        await recipeModel.addRecipeStep(recipe_id, i + 1, steps[i]);
      }
    }

    const awarded_points = 10;
    await userModel.updatePoints(submitted_by,"post_recipe",awarded_points);

    res.status(201).json({
      message: `Recipe created successfully. You earned ${awarded_points} points!`,
      recipe: newRecipe,
      image: recipe_image,
    });
  } catch (error) {
    console.error("Error creating recipe:", error);
    res.status(500).json({ message: "Recipe creation failed" });
  }
}

async function updateRecipeImage(req,res) {
  try {
    const recipe_id = req.params.id;

    if(!req.file) {
      return res.status(400).json({message:'No image uploaded'});
    }
    
    const recipe = await recipeModel.getRecipeInfoById(recipe_id);
    if (!recipe) return res.status(404).json({ message: "Recipe not found" });
    
    if (recipe.submitted_by !== req.user.id && req.user.role !== "Admin") {
      return res.status(403).json({ message: "You can only update your own recipes" });
    }

    const image_name = req.file.filename;
    const image_url = `/images/recipes/${image_name}`;

    const updated_image = await recipeModel.updateRecipeImage(recipe_id,image_url,image_name);
    
    if (recipe.image_name) {
      console.log(recipe.image_name)
      const filename = path.basename(recipe.image_name);

      const oldImagePath = path.join(__dirname, '..', '..', 'images', 'recipes', filename);

      fs.unlink(oldImagePath, (err) => {
        if (err) console.error('Failed to delete old image:', err);
      });
    }

    res.status(200).json({message:'Recipe image updated', image:updated_image});

  } catch (error) {
    console.error('Error while updating recipe image:',error);
    res.status(500).json({message:'failed to update recipe image'});
  }
};

async function createReview(req,res) {
    try {
        console.log('Review posted');
        const user_id = req.user.id;
        const {rating,comment} = req.body;
        const recipe_id = req.params.id;
        const review = await reviewModel.addReview(user_id,recipe_id,rating,comment);
        const recipe = await recipeModel.getRecipeInfoById(recipe_id);
        const recipe_author_id = recipe.submitted_by;

        if(req.file) {
            const image_name = req.file.filename;
            const image_url = `/images/reviews/${image_name}`;
            await reviewModel.addReviewImage(review.review_id, image_name,image_url);
        };

        if(rating >= 3) {
            const points = 5;
            await userModel.updatePoints(recipe_author_id,'Recived Positive Review',points);
        } else if(rating < 3) {
            const points = -5;
            await userModel.updatePoints(recipe_author_id,'Recived Negative Review',points);
        };

        res.status(201).json({message:'Review added!',review});
    } catch (error) {
        console.error('Error while adding review:',error);
        res.status(500).json({message:'Failed to add review'});
    }
};